# backend/main.py
import asyncio
import logging

from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.filters import CommandStart, Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo

from config import settings


logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

bot = Bot(token=settings.bot_token)
dp = Dispatcher()


@dp.message(CommandStart())
async def cmd_start(message: Message):
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è üé≠",
                web_app=WebAppInfo(url="http://localhost:3000")  # ‚Üê –≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—à—å
            )
        ]
    ])

    await message.answer(
        "<b>–ü—Ä–∏–≤–µ—Ç!</b>\n\n"
        "–Ø –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ —Ç–µ–±—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.\n"
        "–°–Ω–∞—á–∞–ª–∞ –∑–∞–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∑–∞–ø–æ–ª–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ üëá",
        reply_markup=keyboard,
        parse_mode="HTML",
        disable_web_page_preview=True
    )


@dp.message(Command("test"))
async def cmd_test(message: Message):
    await message.answer("–ë–æ—Ç –∂–∏–≤–æ–π! –í—Å—ë –æ–∫.")


@dp.message()
async def echo_handler(message: Message):
    # –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    await message.answer(f"–¢—ã –Ω–∞–ø–∏—Å–∞–ª: {message.text}")


async def main():
    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await dp.start_polling(
        bot,
        allowed_updates=dp.resolve_used_update_types(),
        drop_pending_updates=True
    )


if __name__ == "__main__":
    asyncio.run(main())